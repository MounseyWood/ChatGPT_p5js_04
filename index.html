<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Cloth â€“ Refined Sphere & Cylinder Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.5.0/lib/p5.min.js"></script>
  <style>
    /* (same styling as before) */
  </style>
</head>
<body>
<div id="uiPanel">
  <h2>3D Cloth Simulation</h2>
  <p>
    <strong>Sphere</strong>: bottom=0, top=200 (center=100, radius=100), cloth pinned at y=0.<br>
    <strong>Cylinder</strong>: top=150, bottom=450, cloth pinned at y=150.<br>
    Turn on Stretch, Shear, Bending + set Iterations=8+ for stable collisions.
  </p>
  <!-- The rest of your UI: simMode, formMode, interaction, param toggles, etc. -->
  <button id="resetOrientationBtn">Reset Orientation</button>
  <button id="resetBtn">Reset Cloth</button>
</div>
<div id="canvasContainer"></div>

<script>
/* CLOTH SETTINGS */
let cols=20, rows=20, spacing=20;
let clothPoints=[], clothConstraints=[];
let grid=[], horizontal=[], vertical=[], centers=[];

/* SPHERE: bottom=0, top=200 => center=100, radius=100 */
let sphereCenter={x:0,y:100,z:0};
let sphereRadius=100;

/* CYLINDER: top=150, bottom=450 => height=300, pinned at y=150 */
let cylinderTopY=150, cylinderBottomY=450, cylRadius=100;
let cylHeight=cylinderBottomY - cylinderTopY; // 300

/* Simulation parameters & toggles (like before) */
let damping=0.98, iterations=8, stretchFactor=1.0, shearFactor=1.0, bendingFactor=1.0;
let weight=1.0, windX=0.2, windY=0, windZ=0.1, windBuffer=1.0, gravity=0.4;
let dampingOn=false, iterationsOn=false, stretchOn=false, shearOn=false, bendingOn=false;
let weightOn=false, windXOn=false, windYOn=false, windZOn=false, windBufOn=false, gravityOn=false;
let shadingOn=false;

/* MODES */
let simulationMode="plane"; // or "draped"
let formMode="sphere";      // or "cylinder"
let pinningMode="top";
let interactionMode="rotate";
let doResetOrientation=false, simulationRunning=true;
let dragPointIndex=null, dragPlaneZ=0;
let clothShiftX=-40;

function setup(){
  createCanvas(windowWidth-280,windowHeight,WEBGL).parent("canvasContainer");
  // createUI() => set up your toggles, sliders, etc.
  setupCloth();
}

function setupCloth(){
  clothPoints=[]; clothConstraints=[];
  grid=[]; horizontal=[]; vertical=[]; centers=[];
  let clothWidth=(cols-1)*spacing, clothHeight=(rows-1)*spacing;

  if(simulationMode==="plane"){
    let startX=-clothWidth/2+clothShiftX, startY=-clothHeight/2;
    createPlaneCloth(startX,startY,0);
  } else {
    if(formMode==="sphere"){
      // Sphere: pinned at y=0, so cloth can fall to y=200
      let startY=0; // pinned row
      createDrapedCloth(-clothWidth/2, startY, -clothHeight/2);
      let midRow=Math.floor(rows/2), midCol=Math.floor(cols/2);
      let cIdx=grid[midRow][midCol];
      clothPoints[cIdx].pinned=true;
      clothPoints[cIdx].x=0; clothPoints[cIdx].y=0; clothPoints[cIdx].z=0;
    } else {
      // Cylinder: pinned at y=150, can fall to y=450
      let startY=cylinderTopY; // 150
      createDrapedCloth(-clothWidth/2, startY, -clothHeight/2);
      let midRow=Math.floor(rows/2), midCol=Math.floor(cols/2);
      let cIdx=grid[midRow][midCol];
      clothPoints[cIdx].pinned=true;
      clothPoints[cIdx].x=0; clothPoints[cIdx].y=cylinderTopY; clothPoints[cIdx].z=0;
    }
  }
  createSubPointsAndConstraints();
}

function createPlaneCloth(startX,startY,startZ){
  // (same logic as before)
}

function createDrapedCloth(startX,fixedY,startZ){
  // (same logic as before)
}

function createSubPointsAndConstraints(){
  // (same subdiv approach: horizontal, vertical, centers, then constraints)
  // Include structural (stretch), bending, shear, subdivided triangles.
}

function draw(){
  background(30);
  if(doResetOrientation){
    // Shift camera up a bit
    camera(0,-200,(height/2)/tan(PI*30/180), 0,100,0, 0,1,0);
    doResetOrientation=false;
  }
  if(interactionMode==="rotate") orbitControl();
  if(simulationRunning) updateCloth();

  if(simulationMode==="draped"){
    noStroke(); fill("#222");
    if(formMode==="sphere"){
      push();
      translate(sphereCenter.x,sphereCenter.y,sphereCenter.z); // center= (0,100,0)
      sphere(sphereRadius); // radius=100 => bottom=0, top=200
      pop();
    } else {
      // Cylinder top=150, bottom=450 => midpoint=300
      push();
      let midY=(cylinderTopY+cylinderBottomY)/2; // 300
      translate(0,midY,0);
      cylinder(cylRadius, cylHeight);
      pop();
    }
  }

  // (shadingOn => fill cloth, otherwise wireframe)
  // (draw constraints + points)
}

function updateCloth(){
  // We can do a multi-pass collision approach:
  doVerlet();
  for(let i=0;i< (iterationsOn?iterations:1); i++){
    doConstraints();
    // Additional collision passes reduce passing-through
    doSphereCollision();
    doCylinderCollision();
  }
  // Then do ceiling/floor clamp if you want
  if(simulationMode==="draped"){
    if(formMode==="sphere") doSphereCollision();
    else doCylinderCollision();
    doCeilingClampIfNeeded();
    doFloorClampIfNeeded();
  }
}

function doVerlet(){
  // (apply damping, wind, gravity, etc.)
}
function doConstraints(){
  // (relax constraints)
}
function doSphereCollision(){
  // sphereCenter= (0,100,0), radius=100 => bottom=0, top=200
  // (same friction approach, maybe multiple passes)
}
function doCylinderCollision(){
  // top=150, bottom=450 => if 150<=y<=450 => check radial
}
function doCeilingClampIfNeeded(){
  // If pinned at y=0 or y=150 => clamp if cloth tries to go above that
}
function doFloorClampIfNeeded(){
  // If sphere top=200 => clamp if cloth tries to go >200
  // If cylinder bottom=450 => clamp if cloth tries to go >450
}
</script>
</body>
</html>
